#!/bin/bash

NGINX_CONF=${NGINX_CONF-/opt/app-root/etc/nginx.conf}
NGINX_TEMPL=${NGINX_TEMPL-/opt/app-root/etc/nginx.conf.tmpl}

source /opt/app-root/etc/generate_container_user

set -e

source ${NGINX_CONTAINER_SCRIPTS_PATH}/common.sh

process_extending_files ${NGINX_APP_ROOT}/src/nginx-start ${NGINX_CONTAINER_SCRIPTS_PATH}/nginx-start

if [ ! -v NGINX_LOG_TO_VOLUME -a -v NGINX_LOG_PATH ]; then
    /bin/ln -s /dev/stdout ${NGINX_LOG_PATH}/access.log
    /bin/ln -s /dev/stderr ${NGINX_LOG_PATH}/error.log
fi

envsubst_config() {
  if ls "$NGINX_TEMPL" > /dev/null 2>&1 ; then
    echo "---> substituting environment variables in templates"
        envsubst < "$NGINX_TEMPL" > "$NGINX_CONF"
      fi
    done
  fi
}

envsubst_config


exec nginx -g "daemon off;"